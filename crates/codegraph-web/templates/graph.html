<!-- Graph Visualization Page -->
<div class="h-full flex flex-col">
    <div class="mb-4 flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Knowledge Graph</h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Explore UI component relationships and patterns.</p>
        </div>
        <div class="flex items-center space-x-2">
            <select id="graphFilter" onchange="updateGraph()" class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 text-sm px-3 py-1.5">
                <option value="">All categories</option>
                <option value="button">Buttons</option>
                <option value="card">Cards</option>
                <option value="form">Forms</option>
                <option value="navigation">Navigation</option>
                <option value="modal">Modals</option>
            </select>
            <button onclick="resetGraph()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500" title="Reset view">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </button>
            <button onclick="toggleFullscreen()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500" title="Fullscreen">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Graph container -->
    <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden relative" style="min-height: 500px;">
        <div id="graphContainer" class="w-full h-full"></div>

        <!-- Legend -->
        <div class="absolute bottom-4 left-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-3">
            <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Node Types</div>
            <div class="space-y-1 text-xs">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-primary-500 mr-2"></span> UIElement</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-secondary-400 mr-2"></span> DesignSystem</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-emerald-500 mr-2"></span> Category</div>
            </div>
            <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mt-3 mb-2">Relationships</div>
            <div class="space-y-1 text-xs">
                <div class="flex items-center"><span class="w-6 border-t-2 border-primary-400 mr-2"></span> SIMILAR_TO</div>
                <div class="flex items-center"><span class="w-6 border-t-2 border-emerald-400 border-dashed mr-2"></span> USES_DESIGN_SYSTEM</div>
                <div class="flex items-center"><span class="w-6 border-t-2 border-gray-400 mr-2"></span> HAS_CATEGORY</div>
            </div>
        </div>

        <!-- Node details panel -->
        <div id="nodeDetails" class="absolute top-4 right-4 w-72 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-4 hidden">
            <div class="flex items-center justify-between mb-3">
                <h4 id="nodeName" class="font-semibold text-gray-900 dark:text-white"></h4>
                <button onclick="closeNodeDetails()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="nodeInfo" class="space-y-2 text-sm text-gray-600 dark:text-gray-400"></div>
        </div>

        <!-- Loading state -->
        <div id="graphLoading" class="absolute inset-0 bg-white/80 dark:bg-gray-800/80 flex items-center justify-center">
            <div class="text-center">
                <svg class="animate-spin h-10 w-10 text-primary-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <p class="text-gray-500 dark:text-gray-400">Loading graph data...</p>
            </div>
        </div>
    </div>

    <!-- Stats bar -->
    <div class="mt-4 grid grid-cols-4 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <div id="statNodes" class="text-2xl font-bold text-primary-600">0</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Total Nodes</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <div id="statEdges" class="text-2xl font-bold text-green-600">0</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Relationships</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <div id="statDegree" class="text-2xl font-bold text-secondary-500">0</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Avg Degree</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 text-center">
            <div id="statCategories" class="text-2xl font-bold text-primary-500">0</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Categories</div>
        </div>
    </div>
</div>

<script>
    let simulation, svg, g, link, node;
    let graphData = { nodes: [], links: [] };

    // Initialize the graph
    function initGraph() {
        const container = document.getElementById('graphContainer');
        const width = container.clientWidth;
        const height = container.clientHeight || 500;

        svg = d3.select('#graphContainer')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .call(d3.zoom().on('zoom', (event) => {
                g.attr('transform', event.transform);
            }));

        g = svg.append('g');

        // Arrow markers for directed edges
        svg.append('defs').selectAll('marker')
            .data(['similar', 'uses', 'category'])
            .join('marker')
            .attr('id', d => `arrow-${d}`)
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('fill', d => d === 'similar' ? '#FDB022' : d === 'uses' ? '#10B981' : '#6B7280')
            .attr('d', 'M0,-5L10,0L0,5');

        link = g.append('g').attr('class', 'links').selectAll('line');
        node = g.append('g').attr('class', 'nodes').selectAll('g');

        simulation = d3.forceSimulation()
            .force('link', d3.forceLink().id(d => d.id).distance(80))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(30));

        loadGraphData();
    }

    async function loadGraphData() {
        try {
            const [elementsRes, statsRes] = await Promise.all([
                fetch('/api/graph/elements?per_page=100'),
                fetch('/api/graph/stats')
            ]);

            const elements = await elementsRes.json();
            const stats = await statsRes.json();

            // Update stats
            document.getElementById('statNodes').textContent = stats.total_nodes;
            document.getElementById('statEdges').textContent = stats.total_relationships;
            document.getElementById('statDegree').textContent = stats.avg_degree.toFixed(1);
            document.getElementById('statCategories').textContent = stats.nodes_by_label?.length || 0;

            // Convert to D3 format
            graphData = convertToGraphData(elements.elements || []);
            updateGraph();

            document.getElementById('graphLoading').classList.add('hidden');

        } catch (error) {
            console.error('Error loading graph:', error);
            document.getElementById('graphLoading').innerHTML = `
                <div class="text-center">
                    <p class="text-red-500">Error loading graph data</p>
                    <button onclick="loadGraphData()" class="mt-2 text-primary-600 hover:underline">Retry</button>
                </div>
            `;
        }
    }

    function convertToGraphData(elements) {
        const nodes = [];
        const links = [];
        const categories = new Set();
        const designSystems = new Set();

        // Create element nodes
        elements.forEach(elem => {
            nodes.push({
                id: elem.id,
                name: elem.name,
                type: 'element',
                category: elem.category,
                design_system: elem.design_system
            });

            categories.add(elem.category);
            if (elem.design_system) {
                designSystems.add(elem.design_system);
            }
        });

        // Create category nodes
        categories.forEach(cat => {
            nodes.push({
                id: `cat-${cat}`,
                name: cat,
                type: 'category'
            });
        });

        // Create design system nodes
        designSystems.forEach(ds => {
            nodes.push({
                id: `ds-${ds}`,
                name: ds,
                type: 'design_system'
            });
        });

        // Create links
        elements.forEach(elem => {
            // Link to category
            links.push({
                source: elem.id,
                target: `cat-${elem.category}`,
                type: 'category'
            });

            // Link to design system
            if (elem.design_system) {
                links.push({
                    source: elem.id,
                    target: `ds-${elem.design_system}`,
                    type: 'uses'
                });
            }
        });

        return { nodes, links };
    }

    function updateGraph() {
        const filter = document.getElementById('graphFilter').value;
        let filteredData = { ...graphData };

        if (filter) {
            const filteredNodes = graphData.nodes.filter(n =>
                n.type !== 'element' || n.category === filter
            );
            const nodeIds = new Set(filteredNodes.map(n => n.id));
            filteredData = {
                nodes: filteredNodes,
                links: graphData.links.filter(l =>
                    nodeIds.has(l.source.id || l.source) &&
                    nodeIds.has(l.target.id || l.target)
                )
            };
        }

        // Update links
        link = link.data(filteredData.links, d => `${d.source.id || d.source}-${d.target.id || d.target}`);
        link.exit().remove();
        link = link.enter()
            .append('line')
            .attr('stroke', d => d.type === 'similar' ? '#FDB022' : d.type === 'uses' ? '#10B981' : '#6B7280')
            .attr('stroke-width', 1.5)
            .attr('stroke-dasharray', d => d.type === 'uses' ? '5,5' : null)
            .attr('marker-end', d => `url(#arrow-${d.type})`)
            .merge(link);

        // Update nodes
        node = node.data(filteredData.nodes, d => d.id);
        node.exit().remove();

        const nodeEnter = node.enter()
            .append('g')
            .attr('class', 'node')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended))
            .on('click', (event, d) => showNodeDetails(d));

        nodeEnter.append('circle')
            .attr('r', d => d.type === 'element' ? 8 : 12)
            .attr('fill', d => {
                if (d.type === 'element') return '#F59E0B';
                if (d.type === 'design_system') return '#FB7185';
                return '#10B981';
            })
            .attr('stroke', '#fff')
            .attr('stroke-width', 2);

        nodeEnter.append('text')
            .attr('dx', 15)
            .attr('dy', 4)
            .attr('class', 'text-xs fill-gray-700 dark:fill-gray-300')
            .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name);

        node = nodeEnter.merge(node);

        // Update simulation
        simulation.nodes(filteredData.nodes).on('tick', ticked);
        simulation.force('link').links(filteredData.links);
        simulation.alpha(1).restart();
    }

    function ticked() {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    function showNodeDetails(d) {
        const panel = document.getElementById('nodeDetails');
        document.getElementById('nodeName').textContent = d.name;

        let info = '';
        if (d.type === 'element') {
            info = `
                <div><strong>Type:</strong> UI Element</div>
                <div><strong>Category:</strong> ${d.category}</div>
                ${d.design_system ? `<div><strong>Design System:</strong> ${d.design_system}</div>` : ''}
                <div><strong>ID:</strong> <code class="text-xs bg-gray-100 dark:bg-gray-700 px-1 rounded">${d.id}</code></div>
            `;
        } else if (d.type === 'design_system') {
            info = `<div><strong>Type:</strong> Design System</div>`;
        } else {
            info = `<div><strong>Type:</strong> Category</div>`;
        }

        document.getElementById('nodeInfo').innerHTML = info;
        panel.classList.remove('hidden');
    }

    function closeNodeDetails() {
        document.getElementById('nodeDetails').classList.add('hidden');
    }

    function resetGraph() {
        document.getElementById('graphFilter').value = '';
        simulation.alpha(1).restart();

        // Reset zoom
        svg.transition().duration(500).call(
            d3.zoom().transform,
            d3.zoomIdentity
        );
    }

    function toggleFullscreen() {
        const container = document.getElementById('graphContainer').parentElement;
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            container.requestFullscreen();
        }
    }

    // Initialize on load
    initGraph();

    // Handle resize
    window.addEventListener('resize', () => {
        const container = document.getElementById('graphContainer');
        const width = container.clientWidth;
        const height = container.clientHeight;
        svg.attr('width', width).attr('height', height);
        simulation.force('center', d3.forceCenter(width / 2, height / 2));
        simulation.alpha(0.3).restart();
    });
</script>
